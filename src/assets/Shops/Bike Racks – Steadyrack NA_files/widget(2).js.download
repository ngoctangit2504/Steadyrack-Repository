var m=Object.defineProperty,P=Object.defineProperties;var w=Object.getOwnPropertyDescriptors;var y=Object.getOwnPropertySymbols;var b=Object.prototype.hasOwnProperty,D=Object.prototype.propertyIsEnumerable;var g=(r,t,e)=>t in r?m(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,L=(r,t)=>{for(var e in t||(t={}))b.call(t,e)&&g(r,e,t[e]);if(y)for(var e of y(t))D.call(t,e)&&g(r,e,t[e]);return r},A=(r,t)=>P(r,w(t));var p=(r,t,e)=>g(r,typeof t!="symbol"?t+"":t,e);var l=(r,t,e)=>new Promise((s,n)=>{var i=c=>{try{T(e.next(c))}catch(h){n(h)}},a=c=>{try{T(e.throw(c))}catch(h){n(h)}},T=c=>c.done?s(c.value):Promise.resolve(c.value).then(i,a);T((e=e.apply(r,t)).next())});import{i as R,g as f,a as v,l as C,_ as S,b as G}from"./f4997a500/preload-helper.GdFnPZJq.js";import{s as U}from"./f4997a500/script.utils.Cq3eJBrV.js";const _={SUBSCRIBE:"TOLSTOY_WIDGET_V2_SUBSCRIBE",MESSAGE:"TOLSTOY_WIDGET_V2_MESSAGE"},E={ADD_TO_CART:"tolstoy_add_to_cart",SPOTLIGHT_QUICK_SHOP:"tolstoy_spotlight_carousel_quick_shop_click",PRODUCT_CARD_CLICK:"tolstoy_product_card_click"},d=class d{constructor(){p(this,"subscribers");p(this,"eventsStatus");p(this,"handleMessage",t=>{const{detail:e}=t;if(e!=null&&e.eventName)switch(e.eventName){case E.ADD_TO_CART:case E.SPOTLIGHT_QUICK_SHOP:case E.PRODUCT_CARD_CLICK:this.subscribe(e.eventName,e.callback);break;default:this.notifySubscribers(e.eventName,e)}});this.subscribers=new Map,this.eventsStatus={[E.ADD_TO_CART]:!1,[E.SPOTLIGHT_QUICK_SHOP]:!1,[E.PRODUCT_CARD_CLICK]:!1}}static getInstance(){return d.instance||(d.instance=new d),d.instance}formatMessage(t){return A(L({},t),{transmissionId:t.transmissionId||"widget-v2",timestamp:Date.now()})}updateEventStatus(t,e){t in this.eventsStatus&&(this.eventsStatus[t]=e)}isEventSubscribed(t){return this.eventsStatus[t]||!1}notifySubscribers(t,e){const s=this.subscribers.get(t);s==null||s.forEach(n=>{try{n(e)}catch(i){console.error(`Error in ${t} callback:`,i)}})}subscribe(t,e){var s;this.subscribers.has(t)||this.subscribers.set(t,new Set),(s=this.subscribers.get(t))==null||s.add(e),this.updateEventStatus(t,!0)}unsubscribe(t,e){const s=this.subscribers.get(t);s==null||s.delete(e),(s==null?void 0:s.size)===0&&this.updateEventStatus(t,!1)}postMessage(t){const e=this.formatMessage(t),s=new CustomEvent(_.MESSAGE,{detail:e});window.dispatchEvent(s)}init(){window.addEventListener(_.SUBSCRIBE,this.handleMessage),window.addEventListener(_.MESSAGE,this.handleMessage);const t=new CustomEvent(_.SUBSCRIBE);window.addEventListener("tolstoyWidgetReady",()=>{window.dispatchEvent(t)},{once:!0})}destroy(){window.removeEventListener(_.SUBSCRIBE,this.handleMessage),window.removeEventListener(_.MESSAGE,this.handleMessage)}};p(d,"instance");let I=d;const M=()=>{I.getInstance().init()},k={PRODUCT_TILE:"tolstoy-product-tile"},Q="./styles/product-tile.css",x="w-full",B="tolstoy-collection-page-tile",z="./styles/collection-page-tile.css",J={display:"flex",width:"100%",height:"100%",position:"relative"},N=(r,t)=>l(void 0,null,function*(){const s=U()&&R()?f():v(),n=new URLSearchParams;n.set("productId",r),n.set("appKey",t);try{return(yield fetch(`${s}/settings/widget/get-product-gallery-config?${n}`)).json()}catch(i){return C(i,"Error getting collection page tile config"),null}}),V="#tolstoy-video-preview",X=".product__media, .product-single__thumbnails, .gallery, .product-gallery, .slider, .carousel, section.product",Y=()=>{var s,n,i;const r=(s=document.querySelector("script[data-product-id]"))==null?void 0:s.getAttribute("data-product-id"),t=(n=document.querySelector("script[data-app-key]"))==null?void 0:n.getAttribute("data-app-key"),e=(i=document.querySelector("script[data-product-gallery-projects]"))==null?void 0:i.getAttribute("data-product-gallery-projects");return{productId:r,appKey:t,productGalleryProjects:e}},H=()=>l(void 0,null,function*(){var r,t,e;try{const{productId:s,appKey:n,productGalleryProjects:i}=Y();if(!s||!n)return;try{const o=JSON.parse(i);if(console.log("productGalleryProjects",o),!(o!=null&&o.length))return}catch(o){console.log("Error parsing product gallery projects:",o);return}const a=yield N(s,n);if(!((r=a==null?void 0:a.product)!=null&&r.images)||!((t=a==null?void 0:a.vodAssets)!=null&&t.length)||!((e=a==null?void 0:a.projects)!=null&&e.length))return;const T=a.product.images.map(o=>o.src),c=new URLSearchParams(location.search).get("test-gallery");if(c){const{renderTestGalleryIfNeeded:o}=yield S(()=>l(void 0,null,function*(){const{renderTestGalleryIfNeeded:u}=yield import("./f4997a500/render-test-gallery.BKbNsT6V.js");return{renderTestGalleryIfNeeded:u}}),[]);o(c,T)}if(a.product.images.find(o=>{var u;return(u=o.alt)==null?void 0:u.includes(V)})){const{initThumbnailAnchorImageDetection:o}=yield S(()=>l(void 0,null,function*(){const{initThumbnailAnchorImageDetection:u}=yield import("./f4997a500/thumbnail-anchor-image-detection.utils.xdujVRhj.js");return{initThumbnailAnchorImageDetection:u}}),[]);return o(a)}const{initFallbackImageDetection:O}=yield S(()=>l(void 0,null,function*(){const{initFallbackImageDetection:o}=yield import("./f4997a500/fallback-image-detection.utils.Bemxk2mJ.js");return{initFallbackImageDetection:o}}),[]);return O(a)}catch(s){C(s,"Error initializing product gallery video")}}),K={PRODUCT_TILE:{key:k.PRODUCT_TILE,controller:()=>S(()=>import("./f4997a500/product-tiles-controller.BzY4ez4B.js"),[])},COLLECTION_PAGE_TILE:{key:B,controller:()=>S(()=>import("./f4997a500/collection-page-tile-controller.5v_wNkoA.js"),[])}},j={PRODUCT_GALLERY_VIDEO:{init:H}},W=()=>l(void 0,null,function*(){try{M(),yield G(K,j)}catch(r){C(r)}});W();export{z as C,I as E,X as G,Q as P,V as T,x as a,J as b};
