var w=Object.defineProperty,P=Object.defineProperties;var D=Object.getOwnPropertyDescriptors;var O=Object.getOwnPropertySymbols;var R=Object.prototype.hasOwnProperty,b=Object.prototype.propertyIsEnumerable;var g=(r,t,e)=>t in r?w(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,y=(r,t)=>{for(var e in t||(t={}))R.call(t,e)&&g(r,e,t[e]);if(O)for(var e of O(t))b.call(t,e)&&g(r,e,t[e]);return r},A=(r,t)=>P(r,D(t));var T=(r,t,e)=>g(r,typeof t!="symbol"?t+"":t,e);var l=(r,t,e)=>new Promise((s,a)=>{var c=i=>{try{E(e.next(i))}catch(h){a(h)}},n=i=>{try{E(e.throw(i))}catch(h){a(h)}},E=i=>i.done?s(i.value):Promise.resolve(i.value).then(c,n);E((e=e.apply(r,t)).next())});import{i as f,g as v,a as G,l as L,_ as S,b as U}from"./bdfc886e7/preload-helper.y0EZfCyA.js";import{s as M,g as I}from"./bdfc886e7/script.utils.D2w9PLfq.js";const d={SUBSCRIBE:"TOLSTOY_WIDGET_V2_SUBSCRIBE",MESSAGE:"TOLSTOY_WIDGET_V2_MESSAGE"},u={ADD_TO_CART:"tolstoy_add_to_cart",SPOTLIGHT_QUICK_SHOP:"tolstoy_spotlight_carousel_quick_shop_click",PRODUCT_CARD_CLICK:"tolstoy_product_card_click"},_=class _{constructor(){T(this,"subscribers");T(this,"eventsStatus");T(this,"handleMessage",t=>{const{detail:e}=t;if(e!=null&&e.eventName)switch(e.eventName){case u.ADD_TO_CART:case u.SPOTLIGHT_QUICK_SHOP:case u.PRODUCT_CARD_CLICK:this.subscribe(e.eventName,e.callback);break;default:this.notifySubscribers(e.eventName,e)}});this.subscribers=new Map,this.eventsStatus={[u.ADD_TO_CART]:!1,[u.SPOTLIGHT_QUICK_SHOP]:!1,[u.PRODUCT_CARD_CLICK]:!1}}static getInstance(){return _.instance||(_.instance=new _),_.instance}formatMessage(t){return A(y({},t),{transmissionId:t.transmissionId||"widget-v2",timestamp:Date.now()})}updateEventStatus(t,e){t in this.eventsStatus&&(this.eventsStatus[t]=e)}isEventSubscribed(t){return this.eventsStatus[t]||!1}notifySubscribers(t,e){const s=this.subscribers.get(t);s==null||s.forEach(a=>{try{a(e)}catch(c){console.error(`Error in ${t} callback:`,c)}})}subscribe(t,e){var s;this.subscribers.has(t)||this.subscribers.set(t,new Set),(s=this.subscribers.get(t))==null||s.add(e),this.updateEventStatus(t,!0)}unsubscribe(t,e){const s=this.subscribers.get(t);s==null||s.delete(e),(s==null?void 0:s.size)===0&&this.updateEventStatus(t,!1)}postMessage(t){const e=this.formatMessage(t),s=new CustomEvent(d.MESSAGE,{detail:e});window.dispatchEvent(s)}init(){window.addEventListener(d.SUBSCRIBE,this.handleMessage),window.addEventListener(d.MESSAGE,this.handleMessage);const t=new CustomEvent(d.SUBSCRIBE);window.addEventListener("tolstoyWidgetReady",()=>{window.dispatchEvent(t)},{once:!0})}destroy(){window.removeEventListener(d.SUBSCRIBE,this.handleMessage),window.removeEventListener(d.MESSAGE,this.handleMessage)}};T(_,"instance");let C=_;const B=()=>{C.getInstance().init()},k={PRODUCT_TILE:"tolstoy-product-tile"},x="./styles/product-tile.css",z="w-full",N="tolstoy-collection-page-tile",q="./styles/collection-page-tile.css",J={display:"flex",width:"100%",height:"100%",position:"relative"},V=(r,t)=>l(void 0,null,function*(){const s=M()&&f()?v():G(),a=new URLSearchParams;a.set("productId",r),a.set("appKey",t);try{return(yield fetch(`${s}/settings/widget/get-product-gallery-config?${a}`)).json()}catch(c){return L(c,"Error getting collection page tile config"),null}}),Y="#tolstoy-video-preview",X=".product__media, .product-single__thumbnails, .gallery, .product-gallery, .slider, .carousel, section.product, .swiper-wrapper",H=()=>l(void 0,null,function*(){var r,t,e;try{const s=I("product-id"),a=I("app-key");if(!s||!a)return;const c=I("product-gallery-projects");try{const o=JSON.parse(c);if(console.log("productGalleryProjects",o),!o.length)return}catch(o){console.error("Error parsing product gallery projects:",o);return}const n=yield V(s,a);if(!((r=n==null?void 0:n.product)!=null&&r.images)||!((t=n==null?void 0:n.vodAssets)!=null&&t.length)||!((e=n==null?void 0:n.projects)!=null&&e.length))return;const E=n.product.images.map(o=>o.src),i=new URLSearchParams(location.search).get("test-gallery");if(i){const{renderTestGalleryIfNeeded:o}=yield S(()=>l(void 0,null,function*(){const{renderTestGalleryIfNeeded:p}=yield import("./bdfc886e7/render-test-gallery.DdtpeuaQ.js");return{renderTestGalleryIfNeeded:p}}),[]);o(i,E)}if(n.product.images.find(o=>o.alt===Y)){const{initThumbnailAnchorImageDetection:o}=yield S(()=>l(void 0,null,function*(){const{initThumbnailAnchorImageDetection:p}=yield import("./bdfc886e7/thumbnail-anchor-image-detection.utils.BlE2VhfO.js");return{initThumbnailAnchorImageDetection:p}}),[]);return o(n)}const{initFallbackImageDetection:m}=yield S(()=>l(void 0,null,function*(){const{initFallbackImageDetection:o}=yield import("./bdfc886e7/fallback-image-detection.utils.D4KoqyUh.js");return{initFallbackImageDetection:o}}),[]);return m(n)}catch(s){L(s,"Error initializing product gallery video")}}),K={PRODUCT_TILE:{key:k.PRODUCT_TILE,controller:()=>S(()=>import("./bdfc886e7/product-tiles-controller.CEtEo650.js"),[])},COLLECTION_PAGE_TILE:{key:N,controller:()=>S(()=>import("./bdfc886e7/collection-page-tile-controller.DhvtuVD4.js"),[])}},W={PRODUCT_GALLERY_VIDEO:{init:H}},j=()=>l(void 0,null,function*(){try{B(),yield U(K,W)}catch(r){L(r)}});j();export{q as C,C as E,X as G,x as P,Y as T,z as a,J as b};
